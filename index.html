<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SIR Model Playground</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    </head>
    <body>
        <div class="container">
            <h1 class="text-center">SIR Model Playground</h1>
            <p class="text-center">This is a simulator to visualize the spread
            of an infectious disease using the <a
            href="https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology#The_SIR_model">SIR
            model</a>. Set the parameters in
            the input boxes below the charts and press 'Start' to run the
            simulation. The line chart represents the number of people in each
            of the three compartments on any given day and the scatter plot
            represents the location of people within a grid-like city on the
            current day. The simulation will stop when the 'Stop' button is
            pressed or when the disease has been irradicated.</p>
        </div>
        <div class="row">
            <div class="col-sm">
                <canvas id="sir-chart"></canvas>
            </div>
            <div class="col-sm">
                <canvas id="city-chart"></canvas>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-sm">
                    <div class="form-group">
                        <label for="population">Population<span
                        class="text-muted"> - The number of people in the
                        city.</span></label>
                        <input class="form-control" type="number" name="population" id="population">
                    </div>
                    <div class="form-group">
                        <label for="recover-after">Recover After<span
                        class="text-muted"> - The number of days after which
                        someone with the virus recovers and can no longer pass
                        it to others.</span></label>
                        <input class="form-control" type="number" name="recover-after" id="recover-after">
                    </div>
                    <div class="form-group">
                        <label for="time-interval">Time Interval<span
                        class="text-muted"> - The number of milliseconds to wait before
                        progressing the model to the next day.</span></label>
                        <input class="form-control" type="number" name="time-interval" id="time-interval">
                    </div>
                    <div class="form-group">
                        <label for="city-size">City size<span
                        class="text-muted"> - The dimensions of square
                        representing the city. Each person occupies a 1x1 cell
                        within the city.</span></label>
                        <input class="form-control mb-2" type="number" name="city-size" id="city-size">
                    </div>
                </div>
                <div class="col-sm">
                    <div class="form-group">
                        <label for="daily-movement">Daily Movement<span
                        class="text-muted"> - The maximum number of cells a
                        single person can move in either direction per day.</span></label>
                        <input class="form-control" type="number" name="daily-movement" id="daily-movement">
                    </div>
                    <div class="form-group">
                        <label for="infection-radius">Infection Radius<span
                        class="text-muted"> - The radius around each person
                        within which others are at risk of infection.</span></label>
                        <input class="form-control" type="number" name="infection-radius" id="infection-radius">
                    </div>
                    <div class="form-group">
                        <label for="contact-infection-days">Contact Infection
                        Days<span class="text-muted"> - The number of days a
                        person must spend within the infection radius of an
                        infected person to contract the virus.</span></label>
                        <input class="form-control" type="number" name="contact-infection-days" id="contact-infection-days">
                    </div>
                    <div class="form-group">
                        <label for="initial-cases">Initial Cases<span
                        class="text-muted"> - The number of randomly assigned
                        initial cases of the virus.</span></label>
                        <input class="form-control" type="number" name="initial-cases" id="initial-cases">
                    </div>
                </div>
            </div>
            <button class="btn btn-success btn-block" id="start">Start</button>
            <button class="btn btn-danger btn-block" id="stop">Stop</button>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <script>
        var ctx = document.getElementById('sir-chart').getContext('2d');
        //Chart.defaults.global.elements.point.radius = 0;
        var sirChart = new Chart(ctx, {
            type: 'line',
            data: data = {
                labels: [],
                datasets: [{
                    label: 'Susceptible',
                    fill: false,
                    backgroundColor: '#d4db0a',
                    borderColor: '#d4db0a',
                    data: []
                }, {
                    label: 'Infectious',
                    fill: false,
                    backgroundColor: '#b80c09',
                    borderColor: '#b80c09',
                    data: []
                }, {
                    label: 'Recovered',
                    fill: false,
                    backgroundColor: '#09b734',
                    borderColor: '#09b734',
                    data: []
                }]
            },
            options: {
                tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
                elements: {
                    point: {
                        radius: 0
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });

        var ctx = document.getElementById('city-chart').getContext('2d');
        var cityChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Susceptible',
                    backgroundColor: '#d4db0a',
                    borderColor: '#d4db0a',
                    data: []
                }, {
                    label: 'Infectious',
                    backgroundColor: '#b80c09',
                    borderColor: '#b80c09',
                    data: []
                }, {
                    label: 'Recovered',
                    backgroundColor: '#09b734',
                    borderColor: '#09b734',
                    data: []
                }]
            },
            options: {
                animation: {
                    duration: 0
                },
                tooltips: {
					enabled: false
				}
            }
        });

        var population = [];
        var recoverAfter;
        var timeInterval;
        var citySize;
        var dailyMovement;
        var infectionRadius;
        var contactInfectionDays;
        var initialCases;
        var day = 1;
        var timer;

        document.getElementById("start").addEventListener("click", function(){
            this.disabled = true;
            sirChart.data.labels = [];
            sirChart.data.datasets[0].data = [];
            sirChart.data.datasets[1].data = [];
            sirChart.data.datasets[2].data = [];
            population = [];
            day = 1;
            
            recoverAfter = parseInt(document.getElementById("recover-after").value, 10);
            timeInterval = parseInt(document.getElementById("time-interval").value, 10);
            citySize = parseInt(document.getElementById("city-size").value, 10);
            dailyMovement = parseInt(document.getElementById("daily-movement").value, 10);
            infectionRadius = parseInt(document.getElementById("infection-radius").value, 10);
            contactInfectionDays = parseInt(document.getElementById("contact-infection-days").value, 10);
            initialCases = parseInt(document.getElementById("initial-cases").value, 10);

            cityChart.options.scales.xAxes[0].ticks.max = citySize;
            cityChart.options.scales.yAxes[0].ticks.max = citySize;

            for (var i = 0; i < parseInt(document.getElementById("population").value, 10); ++i) {
                if (i < initialCases) {
                    population.push({"compartment": 1, "infectedDays": 0, "x": Math.floor(Math.random() * citySize), "y": Math.floor(Math.random() * citySize), "contactDays": 0});
                    cityChart.data.datasets[1].data.push({"x": population[i].x, "y": population[i].y});
                } else {
                    population.push({"compartment": 0, "x": Math.floor(Math.random() * citySize), "y": Math.floor(Math.random() * citySize), "contactDays": 0});
                    cityChart.data.datasets[0].data.push({"x": population[i].x, "y": population[i].y});
                }
                
                
            }

            for (var i = 0; i < initialCases; ++i) {
                population[i].compartment = 1;
            }

            cityChart.update();

            sirChart.data.labels.push(0);
            sirChart.data.datasets[0].data.push(population.length - initialCases);
            sirChart.data.datasets[1].data.push(initialCases);
            sirChart.data.datasets[2].data.push(0);
            sirChart.update();
            timer = setInterval(progress, timeInterval);
        })

        document.getElementById("stop").addEventListener("click", function(){
            document.getElementById("start").disabled = false;
            clearInterval(timer);
        });

        function progress(){
            cityChart.data.datasets[0].data = [];
            cityChart.data.datasets[1].data = [];
            cityChart.data.datasets[2].data = [];

            var toInfect = [];
            var toRecover = [];
            population.forEach(function(person, index){
                if (person.compartment == 0) {
                    // Filters the rest of the population, return an array of 
                    // arrays containing the index and distance of each infected
                    // person
                    var otherPeople = population.reduce(function(filtered, otherPerson, otherIndex){
                        if (otherPerson.compartment == 1 && index != otherIndex){
                            filtered.push([otherIndex, Math.hypot(Math.abs(person.x - otherPerson.x), Math.abs(person.y - otherPerson.y))]);
                        }
                        return filtered;
                    }, []);

                    otherPeople.sort(function(a, b){return a[1] - b[1]});
                    if (otherPeople[0][1] <= infectionRadius) {
                        population[index].contactDays += 1;
                    } else {
                        population[index].contactDays = 0;
                    }
                    if (population[index].contactDays >= contactInfectionDays) {
                        toInfect.push(index);
                    }
                } else if (person.compartment == 1) {
                    if (person.infectedDays >= recoverAfter) {
                        toRecover.push(index);
                    } else {
                        population[index].infectedDays += 1;
                    }
                }

                do {
                    var newX = person.x + (Math.floor(Math.random() * (dailyMovement * 2 + 1))) - dailyMovement
                    var newY = person.y + (Math.floor(Math.random() * (dailyMovement * 2 + 1))) - dailyMovement
                } while (newX < 0 || newX >= citySize || newY < 0 || newY >= citySize)
                population[index].x = newX;
                population[index].y = newY;
                if (toInfect.includes(index)) {
                    cityChart.data.datasets[1].data.push({"x": newX, "y": newY});
                } else if (toRecover.includes(index)) {
                    cityChart.data.datasets[2].data.push({"x": newX, "y": newY});
                } else {
                    cityChart.data.datasets[population[index].compartment].data.push({"x": newX, "y": newY});
                }
            });
            cityChart.update();

            for (var i = 0; i < toInfect.length; i++) {
                population[toInfect[i]].compartment = 1;
                population[toInfect[i]].infectedDays = 0;
            }
            for (var i = 0; i < toRecover.length; i++) {
                population[toRecover[i]].compartment = 2;
            }
            sirChart.data.labels.push(day);
            day += 1;
            var count = {0: 0, 1: 0, 2: 0};
            population.forEach(function(person){
                count[person["compartment"]] = (count[person["compartment"]]) + 1
            });
            sirChart.data.datasets[0].data.push(count[0]);
            sirChart.data.datasets[1].data.push(count[1]);
            sirChart.data.datasets[2].data.push(count[2]);
            sirChart.update();
            if (count[1] == 0) {
                document.getElementById("start").disabled = false;
                clearInterval(timer);
            }
        }
        </script>
    </body>
</html>